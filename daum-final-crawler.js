#!/usr/bin/env node

/**
 * Daum Sports KBO Í≤ΩÍ∏∞ Í≤∞Í≥º ÌÅ¨Î°§ÎßÅ - ÏµúÏ¢Ö Î≤ÑÏ†Ñ
 */

const puppeteer = require('puppeteer');
const fs = require('fs');

class DaumKBOCrawler {
    constructor() {
        this.browser = null;
        this.page = null;
        this.teamMapping = {
            'Í∏∞ÏïÑ': 'KIA',
            'KIA': 'KIA',
            'Î°ØÎç∞': 'Î°ØÎç∞',
            'LG': 'LG',
            'ÎëêÏÇ∞': 'ÎëêÏÇ∞',
            'SSG': 'SSG',
            'SK': 'SSG',
            'NC': 'NC',
            'ÌïúÌôî': 'ÌïúÌôî',
            'KT': 'KT',
            'ÏÇºÏÑ±': 'ÏÇºÏÑ±',
            'ÌÇ§ÏõÄ': 'ÌÇ§ÏõÄ'
        };
        console.log('üèüÔ∏è Daum Sports KBO ÌÅ¨Î°§Îü¨ ÏãúÏûë...\n');
    }

    async init() {
        console.log('üöÄ Î∏åÎùºÏö∞Ï†Ä ÏãúÏûë...');
        this.browser = await puppeteer.launch({
            headless: true,
            args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage'
            ]
        });
        
        this.page = await this.browser.newPage();
        await this.page.setUserAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
        await this.page.setViewport({ width: 1920, height: 1080 });
        
        console.log('‚úÖ Î∏åÎùºÏö∞Ï†Ä Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    }

    normalizeTeamName(teamName) {
        if (!teamName) return null;
        const cleaned = teamName.trim();
        return this.teamMapping[cleaned] || cleaned;
    }

    async crawlDaumKBO(targetMonth = '202507') {
        try {
            console.log(`üì° Daum Sports KBO ÌÅ¨Î°§ÎßÅ (${targetMonth})`);
            
            const url = `https://sports.daum.net/schedule/kbo?date=${targetMonth}`;
            console.log(`üîó URL: ${url}`);
            
            await this.page.goto(url, { 
                waitUntil: 'networkidle2',
                timeout: 30000 
            });

            await new Promise(resolve => setTimeout(resolve, 3000));

            // Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï†ÄÏû•
            await this.page.screenshot({ path: 'daum-crawling-debug.png', fullPage: true });
            console.log('üì∏ ÎîîÎ≤ÑÍ∑∏ Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï†ÄÏû•: daum-crawling-debug.png');

            // Í≤ΩÍ∏∞ Í≤∞Í≥º Ï∂îÏ∂ú
            const games = await this.page.evaluate(() => {
                const results = [];
                const teams = ['LG', 'ÏÇºÏÑ±', 'KT', 'SSG', 'NC', 'KIA', 'Î°ØÎç∞', 'ÎëêÏÇ∞', 'ÌÇ§ÏõÄ', 'ÌïúÌôî'];
                
                // Î™®Îì† ÌÖåÏù¥Î∏î Í≤ÄÏÇ¨
                const tables = document.querySelectorAll('table');
                console.log(`Ï¥ù ÌÖåÏù¥Î∏î Ïàò: ${tables.length}`);
                
                tables.forEach((table, tableIndex) => {
                    const tableText = table.textContent || '';
                    const hasKBOTeams = teams.some(team => tableText.includes(team));
                    
                    if (!hasKBOTeams) return;
                    
                    console.log(`ÌÖåÏù¥Î∏î ${tableIndex + 1}: KBO Í¥ÄÎ†® ÌÖåÏù¥Î∏î Î∞úÍ≤¨`);
                    
                    const rows = Array.from(table.querySelectorAll('tr'));
                    let currentDate = null;
                    
                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('td, th');
                        if (cells.length === 0) return;
                        
                        const rowText = row.textContent?.trim() || '';
                        
                        // ÎÇ†Ïßú Ìå®ÌÑ¥ Ï∞æÍ∏∞ (7/1, 07/01 Îì±)
                        const dateRegex = /(\d{1,2})\/(\d{1,2})/;
                        const dateMatch = rowText.match(dateRegex);
                        
                        if (dateMatch && cells.length <= 4) {
                            const month = dateMatch[1].padStart(2, '0');
                            const day = dateMatch[2].padStart(2, '0');
                            currentDate = `2025-${month}-${day}`;
                            console.log(`ÎÇ†Ïßú Ìñâ Î∞úÍ≤¨: ${currentDate} (${rowText.substring(0, 30)})`);
                            return;
                        }
                        
                        // Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÌñâÏù∏ÏßÄ ÌôïÏù∏
                        if (currentDate && cells.length >= 4) {
                            const cellTexts = Array.from(cells).map(cell => cell.textContent?.trim() || '');
                            
                            // Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú ÏãúÎèÑ
                            let foundGame = false;
                            
                            // Î∞©Î≤ï 1: [ÌåÄ1] [Ï†êÏàò1] [Ï†êÏàò2] [ÌåÄ2] Ìå®ÌÑ¥
                            for (let i = 0; i <= cellTexts.length - 4; i++) {
                                const team1 = cellTexts[i];
                                const score1Text = cellTexts[i + 1];
                                const score2Text = cellTexts[i + 2];
                                const team2 = cellTexts[i + 3];
                                
                                // ÌåÄÎ™Ö Í≤ÄÏ¶ù
                                const isTeam1Valid = teams.some(team => team1.includes(team));
                                const isTeam2Valid = teams.some(team => team2.includes(team));
                                
                                // Ï†êÏàò Í≤ÄÏ¶ù
                                const score1 = parseInt(score1Text);
                                const score2 = parseInt(score2Text);
                                const areScoresValid = !isNaN(score1) && !isNaN(score2) && score1 >= 0 && score2 >= 0;
                                
                                if (isTeam1Valid && isTeam2Valid && areScoresValid) {
                                    results.push({
                                        date: currentDate,
                                        awayTeam: team1,
                                        homeTeam: team2,
                                        awayScore: score1,
                                        homeScore: score2,
                                        source: `table${tableIndex + 1}_row${rowIndex + 1}_pattern1`
                                    });
                                    
                                    console.log(`Í≤ΩÍ∏∞ Ï∂îÏ∂ú: ${team1} ${score1}:${score2} ${team2} (${currentDate})`);
                                    foundGame = true;
                                    break;
                                }
                            }
                            
                            // Î∞©Î≤ï 2: [ÌåÄ1] [Ï†êÏàò:Ï†êÏàò] [ÌåÄ2] Ìå®ÌÑ¥
                            if (!foundGame) {
                                for (let i = 0; i <= cellTexts.length - 3; i++) {
                                    const team1 = cellTexts[i];
                                    const scoreText = cellTexts[i + 1];
                                    const team2 = cellTexts[i + 2];
                                    
                                    const scoreMatch = scoreText.match(/^(\d+):(\d+)$/);
                                    
                                    if (scoreMatch) {
                                        const isTeam1Valid = teams.some(team => team1.includes(team));
                                        const isTeam2Valid = teams.some(team => team2.includes(team));
                                        
                                        if (isTeam1Valid && isTeam2Valid) {
                                            results.push({
                                                date: currentDate,
                                                awayTeam: team1,
                                                homeTeam: team2,
                                                awayScore: parseInt(scoreMatch[1]),
                                                homeScore: parseInt(scoreMatch[2]),
                                                source: `table${tableIndex + 1}_row${rowIndex + 1}_pattern2`
                                            });
                                            
                                            console.log(`Í≤ΩÍ∏∞ Ï∂îÏ∂ú2: ${team1} ${scoreMatch[1]}:${scoreMatch[2]} ${team2} (${currentDate})`);
                                            foundGame = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
                
                console.log(`Ï¥ù Ï∂îÏ∂úÎêú Í≤ΩÍ∏∞ Ïàò: ${results.length}`);
                return results;
            });

            console.log(`‚úÖ DaumÏóêÏÑú ${games.length}Í∞ú Í≤ΩÍ∏∞ Ï∂îÏ∂ú`);
            
            if (games.length > 0) {
                // ÌåÄÎ™Ö Ï†ïÍ∑úÌôî
                const normalizedGames = games.map(game => ({
                    ...game,
                    awayTeam: this.normalizeTeamName(game.awayTeam),
                    homeTeam: this.normalizeTeamName(game.homeTeam)
                })).filter(game => game.awayTeam && game.homeTeam);

                console.log(`üîÑ Ï†ïÍ∑úÌôî ÌõÑ: ${normalizedGames.length}Í∞ú Í≤ΩÍ∏∞`);
                
                // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ ÎÇ†Ïßú, Í∞ôÏùÄ ÌåÄ, Í∞ôÏùÄ Ï†êÏàò)
                const uniqueGames = [];
                const gameKeys = new Set();
                
                normalizedGames.forEach(game => {
                    const key = `${game.date}-${game.awayTeam}-${game.homeTeam}-${game.awayScore}-${game.homeScore}`;
                    if (!gameKeys.has(key)) {
                        gameKeys.add(key);
                        uniqueGames.push(game);
                    }
                });
                
                console.log(`üîÑ Ï§ëÎ≥µ Ï†úÍ±∞ ÌõÑ: ${uniqueGames.length}Í∞ú Í≤ΩÍ∏∞`);
                
                // ÎÇ†ÏßúÎ≥ÑÎ°ú Ï†ïÎ†¨
                uniqueGames.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Clean.txt ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                const cleanFormat = this.convertToCleanFormat(uniqueGames);
                
                // ÌååÏùº Ï†ÄÏû•
                fs.writeFileSync('daum-crawling-result.txt', cleanFormat, 'utf8');
                console.log('üíæ daum-crawling-result.txtÏóê Ï†ÄÏû• ÏôÑÎ£å');
                
                // ÏÉòÌîå Ï∂úÎ†•
                console.log('\nüìã Ï∂îÏ∂úÎêú Í≤ΩÍ∏∞ (Ï≤òÏùå 15Í∞ú):');
                uniqueGames.slice(0, 15).forEach((game, i) => {
                    console.log(`${i + 1}. ${game.date}: ${game.awayTeam} ${game.awayScore}:${game.homeScore} ${game.homeTeam}`);
                });
                
                return uniqueGames;
            } else {
                console.log('‚ùå Ï∂îÏ∂úÎêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return [];
            }

        } catch (error) {
            console.error(`‚ùå Daum ÌÅ¨Î°§ÎßÅ Ïã§Ìå®: ${error.message}`);
            return [];
        }
    }

    convertToCleanFormat(games) {
        const dateGroups = {};
        
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌôî
        games.forEach(game => {
            if (!dateGroups[game.date]) {
                dateGroups[game.date] = [];
            }
            
            // Clean.txt ÌòïÏãù: "ÏõêÏ†ïÌåÄ Ï†êÏàò:Ï†êÏàò ÌôàÌåÄ(H)"
            const cleanLine = `${game.awayTeam} ${game.awayScore}:${game.homeScore} ${game.homeTeam}(H)`;
            dateGroups[game.date].push(cleanLine);
        });
        
        // ÎÇ†Ïßú ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ Ï∂úÎ†•
        let result = '';
        Object.keys(dateGroups).sort().forEach(date => {
            result += `${date}\n`;
            dateGroups[date].forEach(game => {
                result += `${game}\n`;
            });
            result += '\n';
        });
        
        return result.trim();
    }

    async close() {
        if (this.browser) {
            await this.browser.close();
            console.log('üîö Î∏åÎùºÏö∞Ï†Ä Ï¢ÖÎ£å');
        }
    }
}

// Ïã§Ìñâ
async function main() {
    const crawler = new DaumKBOCrawler();
    
    try {
        await crawler.init();
        const games = await crawler.crawlDaumKBO('202507');
        
        if (games.length > 0) {
            console.log(`\nüéâ ÏÑ±Í≥µ! ${games.length}Í∞ú Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú ÏôÑÎ£å`);
            console.log('üìÑ daum-crawling-result.txt ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        } else {
            console.log('\n‚ö†Ô∏è Ï∂îÏ∂úÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        }
        
    } catch (error) {
        console.error('‚ùå ÌÅ¨Î°§ÎßÅ Ï§ë Ïò§Î•ò:', error);
    } finally {
        await crawler.close();
    }
}

if (require.main === module) {
    main();
}