name: 🏏 KBO 완전 자동화 시스템

on:
  schedule:
    # 매일 한국시간 오후 6시 (UTC 09:00) - 경기 시작 시간
    - cron: '0 9 * * *'
    # 매일 한국시간 오후 10시 (UTC 13:00) - 대부분 경기 종료
    - cron: '0 13 * * *'
    # 매일 한국시간 자정 12시 (UTC 15:00) - 모든 경기 종료 후
    - cron: '0 15 * * *'
  
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  update-kbo-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 저장소 체크아웃
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🟢 Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 의존성 설치
      run: |
        npm ci
        
    - name: 🤖 KBO 데이터 처리 및 업데이트
      run: |
        echo "🏏 KBO 완전 자동화 시스템 시작..."
        echo "📅 실행 시간: $(date)"
        
        # 현재 시스템: clean.txt 기반 완전 자동화 처리
        npm run update-data
        
        echo "✅ 데이터 처리 완료"
        
    - name: 📊 변경사항 확인
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "변경사항이 있습니다."
          echo "has_changes=true" >> $GITHUB_OUTPUT
          git status
        else
          echo "변경사항이 없습니다."
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: 🚀 변경사항 커밋 및 푸시
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        
        git commit -m "🚀 KBO 완전 자동화 업데이트 - $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')

        ✅ 2025-season-data-clean.txt 기반 완전 자동화:
        - 📊 팀별 순위 및 통계 (승률, 홈/원정 기록)
        - 🔮 매직넘버 4종 (플레이오프/우승/탈락/홈어드밴티지)
        - ⚔️ 상대전적 10x10 매트릭스  
        - 🌐 웹서비스 JSON 데이터 동기화
        - 📅 잔여경기 자동 계산

        🤖 Generated with Claude Code
        Co-Authored-By: Claude <noreply@anthropic.com>"
        
        git push
        
    - name: 📢 결과 요약
      run: |
        echo "🎉 KBO 데이터 업데이트 작업 완료!"
        echo "📅 실행 시간: $(date)"
        echo "🔗 워크플로우: ${{ github.workflow }}"
        echo "📊 실행 번호: ${{ github.run_number }}"
        
        if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
          echo "✅ 새로운 데이터가 업데이트되었습니다."
        else
          echo "📌 변경사항이 없어 업데이트하지 않았습니다."
        fi